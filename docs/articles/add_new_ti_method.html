<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Adding a new TI method • dynmethods</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><meta property="og:title" content="Adding a new TI method">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dynmethods</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/add_new_ti_method.html">Adding a new TI method</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Adding a new TI method</h1>
            
            <h4 class="date">2018-05-30</h4>
      
      
      <div class="hidden name"><code>add_new_ti_method.Rmd</code></div>

    </div>

    
    
<p>This vignette describes how to include your own method into the dynverse workflow. We’ll illustrate this with a very basic method: using one of the components of a PCA as the pseudotimes.</p>
<p>There are two main ways to add a new method:</p>
<ul>
<li>
<strong>Directly within R</strong>. In this case you create an R function or R packages. The user will have to install all dependencies. This is th use case described here.</li>
<li>
<strong>Using a docker</strong>. In this case you create a docker which uses some input files (eg. a file containing the expression) and returns some output files. This use case is described in a separate vignette.</li>
</ul>
<p>The main function to create a new ti method is <code>create_ti_method</code>. This wraps:</p>
<ul>
<li>The name of the method</li>
<li>The main function to run a method on a dataset</li>
<li>The parameters required by a method, and their ranges</li>
</ul>
<div id="input" class="section level2">
<h2 class="hasAnchor">
<a href="#input" class="anchor"></a>Input</h2>
<p>To test our method, we will use a very simple toy data example.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dynwrap)
<span class="kw">library</span>(dynmethods)
<span class="kw">library</span>(tidyverse)
<span class="kw">library</span>(ParamHelpers)</code></pre></div>
<p>The main function will receive three different types of input parameters: the expression data, extra parameters and prior information.</p>
<div id="expression-data" class="section level3">
<h3 class="hasAnchor">
<a href="#expression-data" class="anchor"></a>Expression data</h3>
<p>The The raw <code>counts</code> or normalised <code>expression</code>. This is a matrix with in the columns different features (genes) and in the rows different cells.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ncells &lt;-<span class="st"> </span><span class="dv">1000</span>
pseudotimes &lt;-<span class="st"> </span><span class="kw">runif</span>(ncells)

expression &lt;-<span class="st"> </span><span class="kw">matrix</span>(
  <span class="kw">c</span>(
    (pseudotimes <span class="op">-</span><span class="st"> </span><span class="fl">0.5</span>) <span class="op">**</span><span class="st"> </span><span class="dv">2</span>,
    <span class="kw">sqrt</span>(pseudotimes <span class="op">+</span><span class="st"> </span><span class="dv">20</span>),
    pseudotimes
  ),
  <span class="dt">ncol =</span> <span class="dv">3</span>,
  <span class="dt">dimnames =</span> <span class="kw">list</span>(<span class="kw">as.character</span>(<span class="kw">rep</span>(<span class="kw">seq_len</span>(ncells))), <span class="kw">as.character</span>(<span class="kw">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>)))
)
expression &lt;-<span class="st"> </span>expression <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">length</span>(expression), <span class="dt">sd =</span> <span class="fl">0.02</span>)</code></pre></div>
<p>In this example, we’ll use the expression data as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pca &lt;-<span class="st"> </span><span class="kw">prcomp</span>(expression)</code></pre></div>
</div>
<div id="parameters" class="section level3">
<h3 class="hasAnchor">
<a href="#parameters" class="anchor"></a>Parameters</h3>
<p>The main function can accept any additional parameters, which should also be defined in a parameter set using the <code>ParamHelpers</code> package. This allows you to specify the type of parameter (integer, numeric, discrete, logical, …), the possible range of values and the default value.</p>
<p>In this example we’ll define one parameter, the <code>component</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">par_set &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ParamHelpers/topics/makeParamSet">makeParamSet</a></span>(
  <span class="kw"><a href="http://www.rdocumentation.org/packages/ParamHelpers/topics/Param">makeIntegerParam</a></span>(<span class="st">"component"</span>, <span class="dt">lower =</span> <span class="dv">1</span>, <span class="dt">upper =</span> <span class="dv">10</span>, <span class="dt">default =</span> <span class="dv">1</span>)
)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">component &lt;-<span class="st"> </span><span class="dv">1</span>
pseudotimes &lt;-<span class="st"> </span>pca<span class="op">$</span>x[, component]
pseudotimes &lt;-<span class="st"> </span>(pseudotimes <span class="op">-</span><span class="st"> </span><span class="kw">min</span>(pseudotimes)) <span class="op">/</span><span class="st"> </span>(<span class="kw">max</span>(pseudotimes) <span class="op">-</span><span class="st"> </span><span class="kw">min</span>(pseudotimes))</code></pre></div>
</div>
<div id="prior-information" class="section level3">
<h3 class="hasAnchor">
<a href="#prior-information" class="anchor"></a>Prior information</h3>
<p>Prior information can be required (no default) or optional (default is <code>NULL</code>).</p>
<p>Following prior information requests are possible:</p>
<table class="table">
<colgroup>
<col width="17%">
<col width="82%">
</colgroup>
<thead><tr class="header">
<th align="left">Name of parameter</th>
<th align="left">Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">start_id</td>
<td align="left">Vector containing ids of the start cells</td>
</tr>
<tr class="even">
<td align="left">end_id</td>
<td align="left">Vector containing ids of the end cells</td>
</tr>
<tr class="odd">
<td align="left">end_n</td>
<td align="left">The number of end states</td>
</tr>
<tr class="even">
<td align="left">start_n</td>
<td align="left">The number of start states</td>
</tr>
<tr class="odd">
<td align="left">states_id</td>
<td align="left">Named character vector linking the cell ids to different states or clustering</td>
</tr>
<tr class="even">
<td align="left">states_n</td>
<td align="left">Vector containing the number of end states (including start, end and intermediary states)</td>
</tr>
<tr class="odd">
<td align="left">states_network</td>
<td align="left">Dataframe containing the known network between states. Contains a from and to column</td>
</tr>
<tr class="even">
<td align="left">time_id</td>
<td align="left">Named numeric vector linking the cell ids to time points</td>
</tr>
<tr class="odd">
<td align="left">genes_id</td>
<td align="left">Character vector with genes known to be important in the dynamic process</td>
</tr>
</tbody>
</table>
<p>In this example we will use the <code>start_cells</code>…</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">start_cells &lt;-<span class="st"> </span><span class="kw">as.character</span>(<span class="kw">which.min</span>(pseudotimes))</code></pre></div>
<p>as follows</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">if</span> (<span class="op">!</span><span class="kw">is.null</span>(start_cells)) {
  <span class="cf">if</span>(<span class="kw">mean</span>(pseudotimes[start_cells]) <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.5</span>) {
    pseudotimes &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">-</span>pseudotimes
  }
}</code></pre></div>
</div>
</div>
<div id="output" class="section level2">
<h2 class="hasAnchor">
<a href="#output" class="anchor"></a>Output</h2>
<p>In the end, the output of the method should be transformed into the common trajectory format:</p>
<p><strong>[Figure of common output model]</strong></p>
<p>The topology of the trajectory requires:</p>
<ul>
<li>
<code>milestone_ids</code> The ids of the milestones in the trajectory. Type: Character vector.</li>
<li>
<code>milestone_network</code> The network of the milestones. Is a dataframe with columns from, to, length and whether it is directed</li>
<li>
<code>divergence_regions</code> A data frame specifying the divergence regions between milestones (e.g. a bifurcation). Is a dataframe containing a divergence_id, milestone_id, and is_start (TRUE when this milestone is the start of this divergence</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">milestone_ids &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>)
milestone_network &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">from =</span> <span class="st">"A"</span>, <span class="dt">to =</span> <span class="st">"B"</span>, <span class="dt">length =</span> <span class="dv">1</span>, <span class="dt">directed =</span> <span class="ot">TRUE</span>)
divergence_regions &lt;-<span class="st"> </span><span class="kw">tibble</span>()</code></pre></div>
<p>The location of the cells can be provided in two ways:</p>
<ul>
<li>
<code>milestone_percentages</code> A data frame specifying what percentage milestone each cell consists of. Is a dataframe with columns cell_id, milestone_id, and percentage</li>
<li>
<code>progressions</code> Specifies the progression of a cell along a transition in the milestone_network. Is a dataframe with columns cell_id, from, to, and percentage</li>
</ul>
<p>Example of <code>milestone_percentages</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">milestone_percentages &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(
  <span class="kw">tibble</span>(
    <span class="dt">milestone_id =</span> <span class="st">"A"</span>,
    <span class="dt">cell_id =</span> <span class="kw">names</span>(pseudotimes),
    <span class="dt">percentage =</span> <span class="dv">1</span><span class="op">-</span>pseudotimes
  ),
  <span class="kw">tibble</span>(
    <span class="dt">milestone_id =</span> <span class="st">"B"</span>,
    <span class="dt">cell_id =</span> <span class="kw">names</span>(pseudotimes),
    <span class="dt">percentage =</span> pseudotimes
  )
)</code></pre></div>
<p>Example of <code>progressions</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">progressions &lt;-<span class="st"> </span><span class="kw">tibble</span>(
  <span class="dt">cell_id =</span> <span class="kw">names</span>(pseudotimes),
  <span class="dt">from =</span> <span class="st">"A"</span>,
  <span class="dt">to =</span> <span class="st">"B"</span>,
  <span class="dt">percentage =</span> pseudotimes
)</code></pre></div>
<p>We can now wrap this information up:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">trajectory &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/dynwrap/topics/wrap_data">wrap_data</a></span>(
    <span class="dt">cell_id =</span> <span class="kw">names</span>(pseudotimes)
  ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/dynwrap/topics/add_trajectory">add_trajectory</a></span>(
    <span class="dt">milestone_ids =</span> milestone_ids,
    <span class="dt">milestone_network =</span> milestone_network,
    <span class="dt">divergence_regions =</span> divergence_regions,
    <span class="dt">progressions =</span> progressions <span class="co"># either milestone_percentages or progressions have to be provided</span>
  )</code></pre></div>
<p>In some cases, we already provide functions which do the calculation of milestone_percentages or progressions. For example, when a method returns only a linear trajectory with pseudotimes:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">trajectory &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/dynwrap/topics/wrap_data">wrap_data</a></span>(
    <span class="dt">cell_ids =</span> <span class="kw">names</span>(pseudotimes)
  ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/dynwrap/topics/add_linear_trajectory">add_linear_trajectory</a></span>(pseudotimes)</code></pre></div>
<p>Other examples include:</p>
<p><strong>[Figure of common wrapping methods]</strong></p>
<p>We can plot this output using the plotting functions provided by the <code>dynplot</code> package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dynplot<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/dynplot/topics/plot_dimred">plot_dimred</a></span>(trajectory, <span class="st">"pseudotime"</span>, <span class="dt">expression_source =</span> expression)</code></pre></div>
<pre><code>## Pseudotime not provided, will calculate pseudotime from root milestone</code></pre>
<pre><code>## root cell or milestone not provided, trying first outgoing milestone_id</code></pre>
<pre><code>## Using 'milestone_start' as root</code></pre>
<p><img src="add_new_ti_method_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
</div>
<div id="creating-the-method-object" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-the-method-object" class="anchor"></a>Creating the method object</h2>
<p>Combining everything in a function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">run_fun &lt;-<span class="st"> </span><span class="cf">function</span>(expression, component, <span class="dt">start_cells =</span> <span class="ot">NULL</span>) {
  <span class="co"># do pca and extract pseudotimes</span>
  pca &lt;-<span class="st"> </span><span class="kw">prcomp</span>(expression)
  
  pseudotimes &lt;-<span class="st"> </span>pca<span class="op">$</span>x[, component]
  
  <span class="co"># flip pseudotimes using start_cells</span>
  <span class="cf">if</span> (<span class="op">!</span><span class="kw">is.null</span>(start_cells)) {
    <span class="cf">if</span>(<span class="kw">mean</span>(pseudotimes[start_cells]) <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.5</span>) {
      pseudotimes &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">-</span>pseudotimes
    }
  }
  
  <span class="co"># convert to common format</span>
  <span class="kw"><a href="http://www.rdocumentation.org/packages/dynwrap/topics/wrap_data">wrap_data</a></span>(
    <span class="dt">cell_ids =</span> <span class="kw">names</span>(pseudotimes)
  ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/dynwrap/topics/add_linear_trajectory">add_linear_trajectory</a></span>(pseudotimes)
}</code></pre></div>
<p>We can now create the TI object</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ti_dummy &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_ti_method.html">create_ti_method</a></span>(
  <span class="st">"dummy"</span>, 
  par_set,
  run_fun
)</code></pre></div>
<p>This function also has several optional parameters, among which:</p>
<ul>
<li>R packages which have to be installed, and R packages which have to be installed and loaded</li>
<li>The function to plot the output of a method, default is <code><a href="http://www.rdocumentation.org/packages/dynplot/topics/plot_graph">dynplot::plot_default</a></code>
</li>
<li>A short name of the method</li>
</ul>
</div>
<div id="running-the-method" class="section level2">
<h2 class="hasAnchor">
<a href="#running-the-method" class="anchor"></a>Running the method</h2>
<p>Running the method is easy given a task.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">task &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/dynwrap/topics/wrap_data">wrap_data</a></span>(<span class="st">""</span>, <span class="kw">rownames</span>(expression)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/dynwrap/topics/add_expression">add_expression</a></span>(expression, expression)

model &lt;-<span class="st"> </span><span class="kw"><a href="../reference/infer_trajectories.html">infer_trajectory</a></span>(task, <span class="kw">ti_dummy</span>())</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dynplot)
dynplot<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/dynplot/topics/plot_dimred">plot_dimred</a></span>(model, <span class="dt">color_cells =</span> <span class="st">"pseudotime"</span> , <span class="dt">expression_source =</span> task<span class="op">$</span>expression)</code></pre></div>
<pre><code>## Pseudotime not provided, will calculate pseudotime from root milestone</code></pre>
<pre><code>## root cell or milestone not provided, trying first outgoing milestone_id</code></pre>
<pre><code>## Using 'milestone_start' as root</code></pre>
<p><img src="add_new_ti_method_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#input">Input</a></li>
      <li><a href="#output">Output</a></li>
      <li><a href="#creating-the-method-object">Creating the method object</a></li>
      <li><a href="#running-the-method">Running the method</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Robrecht Cannoodt, Wouter Saelens, Helena Todorov.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
